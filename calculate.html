<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/themes/cupertino/jquery-ui.css" type="text/css"/>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.min.js" type="text/javascript"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js" type="text/javascript"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&libraries=places"></script>
<script type="text/javascript">
var map;
var geocoder;
var MARKER_ZOOM_EXTENT = 14;
var DEFAULT_RADIUS = 500;
var markers = new Array();
var types = new Array();
var service;
var brognoli_data;
var places_array = new Array();
var radius_step = 50;
var types = ["grocery_or_supermarket","food","bakery","gym","hospital","health","dentist","doctor","store","establishment","gas_station","laundry","bank"];
function initGoogleMaps() {
	var latlng = new google.maps.LatLng(-27.588784,-48.535967);
	geocoder = new google.maps.Geocoder();
	var myOptions = {
	  zoom: 15,
	  center: latlng,
	  mapTypeId: google.maps.MapTypeId.ROADMAP
	};
	map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
	service = new google.maps.places.PlacesService(map);
}
$(function(){
	initGoogleMaps();	
	$.getJSON('brognoli_places.json', function(data) {
		brognoli_data=data;
		$.getJSON('places.json', function(data) {
			places_array=data;
			for(i=0;i<brognoli_data.length;i++) brognoli_data[i].places = new Array();
			searchPlaces(100,brognoli_data.length, 10,1000);
		});		
	});
});

function addPlaceToMarker(marker,place){
	for(i=0;i<marker.places.length;i++)
		if(marker.places[i] == place.id) {
			return;	
		}
	marker.places.push(place.id);
}
function addPlace(place){
	for(i=0;i<places_array.length;i++)
		if(places_array[i].id==place.id) {
			return;
		}
	places_array.push(place);
}
function searchPlaces(index,limit_index,radius,max_radius){
	var place = new google.maps.LatLng(brognoli_data[index].location.lat, brognoli_data[index].location.lng);
	var marker= brognoli_data[index];
	var request = {location: place, radius: radius,types: types};
    service.search(request, function(results, status){
		if (status == google.maps.places.PlacesServiceStatus.OK) {
			for (var i = 0; i < results.length; i++) {
				addPlace(results[i]);			
				addPlaceToMarker(marker,results[i]);
			}			
			if(radius+radius_step >max_radius) {
				$("#update").text('Done markers ' + marker.places.length + " Doing " + (index+1));
				if(index+1>=limit_index){					
					alert('done all');
				}
				else searchPlaces(index+1,limit_index,10,max_radius);
			}
			else {
				setTimeout(function(){	searchPlaces(index,limit_index, radius+radius_step,max_radius);	}, 100);				
			}
		}
		else if (status == google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
			if(radius+radius_step >max_radius) alert('done ' + marker.places.length);
			else {
				setTimeout(function(){	searchPlaces(index,limit_index, radius+radius_step,max_radius);	}, 100);				
			}
		}
	});
}
function printData(){
	$("#data").append(JSON.stringify(brognoli_data));
	$("#data2").append(JSON.stringify(places_array));
}
</script>
</head>
<body>
<div id="update"></div>
<button onClick="printData()">Imprimir</button>
<div id="map_canvas" style="height:500px;"></div>
<div id="data"></div>
<div id="data2"></div>
</body>
</html>